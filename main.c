#include <stdlib.h>
#include <stdio.h>
#include <libcd.h>

#include "header.h"

#include "renderer.h"
#include "level.h"
#include "input.h"

#include <mruby.h>
#include <mruby/irep.h>

#define HEAP_SIZE (1024 * 1024)
char heap[HEAP_SIZE];

Level level;

const char sokoban_rb[354] = {
    0x52, 0x49, 0x54, 0x45, 0x30, 0x33, 0x30, 0x30, 0x00, 0x00, 0x01,
    0x62, 0x4d, 0x41, 0x54, 0x5a, 0x30, 0x30, 0x30, 0x30, 0x49, 0x52,
    0x45, 0x50, 0x00, 0x00, 0x01, 0x1e, 0x30, 0x33, 0x30, 0x30, 0x00,
    0x00, 0x00, 0x7c, 0x00, 0x03, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x47, 0x11, 0x03, 0x11, 0x04, 0x5c, 0x03, 0x00,
    0x5e, 0x03, 0x00, 0x07, 0x03, 0x08, 0x04, 0x09, 0x05, 0x0a, 0x06,
    0x0b, 0x07, 0x48, 0x01, 0x03, 0x05, 0x10, 0x03, 0x01, 0x03, 0x04,
    0x0c, 0x10, 0x05, 0x02, 0x03, 0x06, 0x0d, 0x53, 0x03, 0x02, 0x01,
    0x02, 0x03, 0x1d, 0x03, 0x00, 0x01, 0x04, 0x01, 0x2f, 0x04, 0x03,
    0x00, 0x2f, 0x03, 0x04, 0x01, 0x01, 0x04, 0x02, 0x10, 0x05, 0x01,
    0x23, 0x04, 0x2f, 0x03, 0x05, 0x01, 0x38, 0x03, 0x69, 0x00, 0x00,
    0x00, 0x06, 0x00, 0x03, 0x46, 0x6f, 0x6f, 0x00, 0x00, 0x01, 0x61,
    0x00, 0x00, 0x01, 0x63, 0x00, 0x00, 0x04, 0x73, 0x69, 0x7a, 0x65,
    0x00, 0x00, 0x03, 0x6e, 0x65, 0x77, 0x00, 0x00, 0x03, 0x62, 0x61,
    0x72, 0x00, 0x00, 0x00, 0x00, 0x39, 0x00, 0x01, 0x00, 0x03, 0x00,
    0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x63, 0x01, 0x58, 0x02,
    0x00, 0x5f, 0x01, 0x00, 0x63, 0x01, 0x58, 0x02, 0x01, 0x5f, 0x01,
    0x01, 0x38, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x0a, 0x69, 0x6e,
    0x69, 0x74, 0x69, 0x61, 0x6c, 0x69, 0x7a, 0x65, 0x00, 0x00, 0x03,
    0x62, 0x61, 0x72, 0x00, 0x00, 0x00, 0x00, 0x27, 0x00, 0x03, 0x00,
    0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x34, 0x04,
    0x00, 0x00, 0x01, 0x03, 0x01, 0x1a, 0x03, 0x00, 0x38, 0x03, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x04, 0x40, 0x62, 0x61, 0x72, 0x00, 0x00,
    0x00, 0x00, 0x36, 0x00, 0x03, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x12, 0x34, 0x04, 0x00, 0x00, 0x01, 0x04, 0x01,
    0x2d, 0x03, 0x00, 0x01, 0x19, 0x04, 0x01, 0x40, 0x03, 0x38, 0x03,
    0x00, 0x00, 0x00, 0x02, 0x00, 0x06, 0x66, 0x6f, 0x6f, 0x62, 0x61,
    0x72, 0x00, 0x00, 0x04, 0x40, 0x62, 0x61, 0x72, 0x00, 0x4c, 0x56,
    0x41, 0x52, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x04, 0x00,
    0x01, 0x61, 0x00, 0x01, 0x62, 0x00, 0x03, 0x66, 0x6f, 0x6f, 0x00,
    0x03, 0x62, 0x61, 0x7a, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02, 0xff,
    0xff, 0x00, 0x03, 0xff, 0xff, 0x45, 0x4e, 0x44, 0x00, 0x00, 0x00,
    0x00, 0x08
};

const int sokoban_rb_length = 354;

void process_input()
{
    if (iptm_quit_requested() || iptm_is_pressed(KEY_QUIT)) {
        printf("[INFO]: quit requested\n");
    }

    if (iptm_is_pressed(KEY_UP)) {
        if (lvl_move_player(&level, DIR_UP)) level.steps++;
    }
    else if (iptm_is_pressed(KEY_DOWN)) {
        if (lvl_move_player(&level, DIR_DOWN)) level.steps++;
    }
    else if (iptm_is_pressed(KEY_LEFT)) {
        if (lvl_move_player(&level, DIR_LEFT)) level.steps++;
    }
    else if (iptm_is_pressed(KEY_RIGHT)) {
        if (lvl_move_player(&level, DIR_RIGHT)) level.steps++;
    }

    if (iptm_is_pressed(KEY_RESTART)) {
        lvl_reset(&level);
    }
}

void mainloop()
{
    unsigned int frame_start;

    while (1) {
        frame_start = rdr_getticks();

        iptm_poll_events();
        process_input();
        lvl_check_level_done(&level);

        rdr_render(&level);
        rdr_delay(frame_start);
    }
}

static mrb_value mrb_f_foobar(mrb_state *mrb, mrb_value self)
{
    mrb_int i;

    mrb_get_args(mrb, "i", &i);

    return mrb_fixnum_value(i);
}

void mrb_helper_init(mrb_state *mrb)
{
    mrb_define_method(mrb, mrb->kernel_module, "foobar", mrb_f_foobar, MRB_ARGS_REQ(1));
}

int main(int argc, char** argv)
{
    mrb_state *mrb;
    mrb_value v;

    InitHeap((void*)&heap, HEAP_SIZE);
    CdInit();

    rdr_init();
    iptm_init();

    printf("[INFO]: init done !\n");

    lvl_init(&level, 0);
    printf("[INFO]: level init done !\n");

    //----

    mrb = mrb_open();
    mrb_helper_init(mrb);

    v = mrb_load_irep(mrb, sokoban_rb);
    printf("EXECUTING MRUBY ON PSX : %d\n", mrb_fixnum(v));
    //----

    mainloop();

    rdr_cleanup();

    return 0;
}
